apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo-app
  labels:
    app: demo-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: demo-app
  template:
    metadata:
      labels:
        app: demo-app
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/role: "myapp-role"
        vault.hashicorp.com/agent-inject-secret-db-creds: "database/creds/readonly-role"
        vault.hashicorp.com/agent-inject-template-db-creds: |
          {{- with secret "database/creds/readonly-role" -}}
          DB_USER={{ .Data.username }}
          DB_PASSWORD={{ .Data.password }}
          {{- end }}
        vault.hashicorp.com/agent-pre-populate: "true"
        vault.hashicorp.com/agent-init-first: "true"
    spec:
      serviceAccountName: vault
      containers:
        - name: app
          image: python:3.10-slim
          command: ["/bin/sh", "-c"]
          args:
            - |
              pip install flask psycopg2-binary;

              cat <<EOF > app.py
              from flask import Flask
              import psycopg2
              import os
              import time
              from datetime import datetime

              app = Flask(__name__)

              @app.route("/")
              def show_messages():
                  try:
                      creds = {}
                      secret_path = "/vault/secrets/db-creds"
                      with open(secret_path, "r") as f:
                          for line in f:
                              if "=" in line:
                                  key, value = line.strip().split("=", 1)
                                  creds[key] = value

                      updated_epoch = os.path.getmtime(secret_path)
                      updated_str = datetime.fromtimestamp(updated_epoch).strftime('%Y-%m-%d %H:%M:%S')

                      ttl_seconds = 30
                      elapsed = int(time.time() - updated_epoch)
                      remaining = max(ttl_seconds - elapsed, 0)

                      conn = psycopg2.connect(
                          dbname="demo",
                          user=creds.get("DB_USER"),
                          password=creds.get("DB_PASSWORD"),
                          host="postgres",
                          port=5432
                      )
                      cur = conn.cursor()
                      cur.execute("SELECT * FROM messages;")
                      rows = cur.fetchall()
                      cur.close()
                      conn.close()

                      table = "".join(f"<tr><td>{r[0]}</td><td>{r[1]}</td></tr>" for r in rows)
                      return f"""
                      <html>
                      <head>
                        <meta http-equiv="refresh" content="1">
                        <style>
                          body {{ font-family: Arial, sans-serif; }}
                          table {{ border-collapse: collapse; width: 60%; }}
                          th, td {{ border: 1px solid #ccc; padding: 8px; }}
                          th {{ background-color: #f2f2f2; }}
                          .section {{ margin-bottom: 30px; }}
                        </style>
                      </head>
                      <body>
                      <div class="section">
                        <h2>ğŸ”§ Vault Agent Injector ã®è£å´ã®å‹•ä½œ</h2>
                        <ul>
                      <div class="section">
                        <h2>ğŸ”§ Vault Agent Injector ã®è£å´ã®å‹•ä½œ</h2>
                        <ul>
                            <li>âœ… <strong>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ Pod ã®èµ·å‹•æ™‚</strong>ã€<strong>Vault Agent</strong> ãŒ Sidecar ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦è‡ªå‹•çš„ã«èµ·å‹•</li>
                            <li>âœ… Kubernetes ã®æ¨™æº–æ©Ÿèƒ½ã§è‡ªå‹•ãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸ <code>/var/run/secrets/kubernetes.io/serviceaccount/token</code> ã® JWT ã‚’ä½¿ç”¨ã—ã€<strong>Vault Agent</strong> ãŒ Vault ã® Kubernetes Auth Method ã«ãƒ­ã‚°ã‚¤ãƒ³</li>
                            <li>âœ… <strong>Vault Agent ãŒãƒ­ã‚°ã‚¤ãƒ³å¾Œã«å–å¾—ã—ãŸ Vault Token</strong> ã¯ã€ãƒ¡ãƒ¢ãƒªä¸Šã«å®‰å…¨ã«ä¿æŒï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ä¿å­˜ã•ã‚Œãªã„æ§‹æˆï¼‰</li>
                            <li>âœ… <strong>Vault Agent ãŒ</strong>ã€Vault Token ã‚’ä½¿ã£ã¦ <code>database/creds/readonly-role</code> ã‹ã‚‰å‹•çš„ãª DB èªè¨¼æƒ…å ±ï¼ˆSecretï¼‰ã‚’å–å¾—</li>
                            <li>âœ… <strong>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ Pod å†…ã® Vault Agent Sidecar ã‚³ãƒ³ãƒ†ãƒŠãŒ</strong> ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã§ Secret ã‚’æ•´å½¢ã—ã€<strong>å…±æœ‰ãƒœãƒªãƒ¥ãƒ¼ãƒ ä¸Šã® <code>/vault/secrets/db-creds</code></strong> ã«ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›</li>
                            <li>ğŸ” <strong>Secret ã® TTL ãŒåˆ‡ã‚Œã‚‹ã¨ã€Vault Agent ãŒè‡ªå‹•çš„ã«å†å–å¾—ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«å†ç”Ÿæˆ</strong>ï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯å†èµ·å‹•ä¸è¦ï¼‰</li>
                        </ul>
                      </div>
                        </ul>
                      </div>

                      <div class="section">
                        <h2>ğŸ“‚ Secret ãƒ•ã‚¡ã‚¤ãƒ«ã®çŠ¶æ…‹</h2>
                        <ul>
                          <li><b>ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹:</b> /vault/secrets/db-creds</li>
                          <li><b>æœ€çµ‚æ›´æ–°æ—¥æ™‚:</b> {updated_str}</li>
                          <li><b>TTL æ®‹ã‚Šç§’æ•°:</b> {remaining} ç§’</li>
                          <li><b>DB_USER:</b> {creds.get("DB_USER")}</li>
                          <li><b>DB_PASSWORD:</b> {creds.get("DB_PASSWORD")}</li>
                        </ul>
                      </div>

                      <div class="section">
                        <h2>ğŸ“‹ Messages Table</h2>
                        <table>
                          <tr><th>ID</th><th>Content</th></tr>
                          {table}
                        </table>
                      </div>

                      <div class="section">
                        <h2>ğŸ”§ æ‰‹å‹•ã‚³ãƒãƒ³ãƒ‰ãƒ¡ãƒ¢</h2>
                        <ul>
                          <li><b>ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°:</b> kubectl port-forward deployment/demo-app 8080:5000</li>
                          <li><b>ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥:</b>  kubectl exec -it $(kubectl get pod -l app=postgres -o jsonpath="{.items[0].metadata.name}") -- psql -U vaultadmin -d demo -c "INSERT INTO messages (id, content) VALUES (999, 'Manual insert from kubectl');"</li>
                        </ul>
                      </div>


                      </body>
                      </html>
                      """
                  except Exception as e:
                      return f"<h2>âŒ Error:</h2><pre>{e}</pre>"

              if __name__ == "__main__":
                  app.run(host="0.0.0.0", port=5000)
              EOF

              python app.py
          ports:
            - containerPort: 5000
