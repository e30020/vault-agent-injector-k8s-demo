apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo-app
  labels:
    app: demo-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: demo-app
  template:
    metadata:
      labels:
        app: demo-app
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/role: "myapp-role"

        # æ—¢å­˜ã®DBã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«æ³¨å…¥è¨­å®š
        vault.hashicorp.com/agent-inject-secret-db-creds: "database/creds/readonly-role"
        vault.hashicorp.com/agent-inject-template-db-creds: |
          {{- with secret "database/creds/readonly-role" -}}
          DB_USER={{ .Data.username }}
          DB_PASSWORD={{ .Data.password }}
          {{- end }}
        vault.hashicorp.com/agent-pre-populate: "true"
        vault.hashicorp.com/agent-init-first: "true"

#        # è¿½åŠ ï¼šTLSè¨¼æ˜æ›¸æ³¨å…¥è¨­å®š
#        vault.hashicorp.com/agent-inject-secret-tls: "pki-int/issue/nginx"
#        vault.hashicorp.com/agent-inject-template-tls.crt: |
#          {{ with secret "pki-int/issue/nginx" "common_name=nginx.example.com" }}
#          {{ .Data.certificate }}
#          {{ .Data.issuing_ca }}
#          {{ range .Data.ca_chain }}
#          {{ . }}
#          {{ end }}
#          {{ end }}
#        vault.hashicorp.com/agent-inject-template-tls.key: |
#          {{ with secret "pki-int/issue/nginx" "common_name=nginx.example.com" }}
#          {{ .Data.private_key }}
#          {{ end }}
    spec:
      serviceAccountName: vault
      containers:
        - name: app
          image: python:3.10-slim
          command: ["/bin/sh", "-c"]
          args:
            - |
              pip install flask psycopg2-binary requests pyOpenSSL;

              cat <<EOF > app.py
              from flask import Flask, request
              import psycopg2, os, time, datetime, requests

              app = Flask(__name__)

              @app.route("/")
              def show_messages():
                  try:
                      creds = {}
                      secret_path = "/vault/secrets/db-creds"
                      with open(secret_path, "r") as f:
                          for line in f:
                              if "=" in line:
                                  key, value = line.strip().split("=", 1)
                                  creds[key] = value

                      updated_epoch = os.path.getmtime(secret_path)
                      updated_str = datetime.datetime.fromtimestamp(updated_epoch).strftime('%Y-%m-%d %H:%M:%S')
                      ttl_seconds = 30
                      elapsed = int(time.time() - updated_epoch)
                      remaining = max(ttl_seconds - elapsed, 0)

                      conn = psycopg2.connect(
                          dbname="demo",
                          user=creds.get("DB_USER"),
                          password=creds.get("DB_PASSWORD"),
                          host="postgres",
                          port=5432
                      )
                      cur = conn.cursor()
                      cur.execute("SELECT * FROM messages;")
                      rows = cur.fetchall()
                      cur.close()
                      conn.close()

                      table = "".join(f"<tr><td>{r[0]}</td><td>{r[1]}</td></tr>" for r in rows)

                      return f"""
                      <html><head><meta http-equiv="refresh" content="3">
                      <style>body {{ font-family: Arial; }}</style></head><body>
                      <a href='/transit'>ğŸ” Transit ãƒ‡ãƒ¢ã¸</a>
                      <div class="section">
                        <h2>ğŸ”§ Vault Agent Injector ã®è£å´ã®å‹•ä½œ</h2>
                        <ul>
                          <li>âœ… <strong>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ Pod ã®èµ·å‹•æ™‚</strong>ã€<strong>Vault Agent</strong> ãŒ Sidecar ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦è‡ªå‹•çš„ã«èµ·å‹•</li>
                          <li>âœ… Kubernetes ã®æ¨™æº–æ©Ÿèƒ½ã§è‡ªå‹•ãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸ <code>/var/run/secrets/kubernetes.io/serviceaccount/token</code> ã® JWT ã‚’ä½¿ç”¨ã—ã€<strong>Vault Agent</strong> ãŒ Vault ã® Kubernetes Auth Method ã«ãƒ­ã‚°ã‚¤ãƒ³</li>
                          <li>âœ… <strong>Vault Agent ãŒãƒ­ã‚°ã‚¤ãƒ³å¾Œã«å–å¾—ã—ãŸ Vault Token</strong> ã¯ã€ãƒ¡ãƒ¢ãƒªä¸Šã«å®‰å…¨ã«ä¿æŒï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ä¿å­˜ã•ã‚Œãªã„æ§‹æˆï¼‰</li>
                          <li>âœ… <strong>Vault Agent ãŒ</strong>ã€Vault Token ã‚’ä½¿ã£ã¦ <code>database/creds/readonly-role</code> ã‹ã‚‰å‹•çš„ãª DB èªè¨¼æƒ…å ±ï¼ˆSecretï¼‰ã‚’å–å¾—</li>
                          <li>âœ… <strong>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ Pod å†…ã® Vault Agent Sidecar ã‚³ãƒ³ãƒ†ãƒŠãŒ</strong> ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã§ Secret ã‚’æ•´å½¢ã—ã€<strong>å…±æœ‰ãƒœãƒªãƒ¥ãƒ¼ãƒ ä¸Šã® <code>/vault/secrets/db-creds</code></strong> ã«ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›</li>
                          <li>ğŸ” <strong>Secret ã® TTL ãŒåˆ‡ã‚Œã‚‹ã¨ã€Vault Agent ãŒè‡ªå‹•çš„ã«å†å–å¾—ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«å†ç”Ÿæˆ</strong>ï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯å†èµ·å‹•ä¸è¦ï¼‰</li>
                        </ul>
                      </div>

                      <div class="section">
                        <h2>ğŸ“‚ Secret ãƒ•ã‚¡ã‚¤ãƒ«ã®çŠ¶æ…‹</h2>
                        <ul>
                          <li><b>ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹:</b> /vault/secrets/db-creds</li>
                          <li><b>æœ€çµ‚æ›´æ–°æ—¥æ™‚:</b> {updated_str}</li>
                          <li><b>TTL æ®‹ã‚Šç§’æ•°:</b> {remaining} ç§’</li>
                          <li><b>DB_USER:</b> {creds.get("DB_USER")}</li>
                          <li><b>DB_PASSWORD:</b> {creds.get("DB_PASSWORD")}</li>
                        </ul>
                      </div>

                      <div class="section">
                        <h2>ğŸ“‹ Messages Table</h2>
                        <table border="1"><tr><th>ID</th><th>Content</th></tr>{table}</table>
                      </div>

                      <div class="section">
                        <h2>ğŸ”§ æ‰‹å‹•ã‚³ãƒãƒ³ãƒ‰ãƒ¡ãƒ¢</h2>
                        <ul>
                          <li><b>ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°:</b> kubectl port-forward deployment/demo-app 8080:5000</li>
                          <li><b>ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥:</b> 'kubectl exec -it $(kubectl get pod -l app=postgres -o jsonpath="{{{{.items[0].metadata.name}}}}") -- psql -U vaultadmin -d demo -c "INSERT INTO messages (id, content) VALUES (999, 'Manual insert');"'</li>
                        </ul>
                      </div>
                      </body></html>
                      """
                  except Exception as e:
                      return f"<h2>âŒ Error:</h2><pre>{e}</pre>"

              @app.route("/transit", methods=["GET", "POST"])
              def transit_demo():
                  VAULT_ADDR = "http://vault:8200"
                  VAULT_TOKEN = "root"
                  KEY_NAME = "my-transit-key"

                  encrypt_input = decrypt_input = ""
                  ciphertext = plaintext = ""
                  encrypt_curl = decrypt_curl = ""

                  if request.method == "POST":
                      mode = request.form.get("mode")

                      if mode == "encrypt":
                          encrypt_input = request.form["encrypt_input"]
                          b64 = encrypt_input.encode("utf-8").hex()
                          res = requests.post(
                              f"{VAULT_ADDR}/v1/transit/encrypt/{KEY_NAME}",
                              headers={"X-Vault-Token": VAULT_TOKEN},
                              json={"plaintext": b64}
                          ).json()
                          ciphertext = res["data"]["ciphertext"]
                          encrypt_curl = f"curl -s -H 'X-Vault-Token: {VAULT_TOKEN}' -d '{{\"plaintext\":\"{b64}\"}}' {VAULT_ADDR}/v1/transit/encrypt/{KEY_NAME}"

                      elif mode == "decrypt":
                          decrypt_input = request.form["decrypt_input"]
                          res = requests.post(
                              f"{VAULT_ADDR}/v1/transit/decrypt/{KEY_NAME}",
                              headers={"X-Vault-Token": VAULT_TOKEN},
                              json={"ciphertext": decrypt_input}
                          ).json()
                          dec = res["data"]["plaintext"]
                          plaintext = bytes.fromhex(dec).decode("utf-8")
                          decrypt_curl = f"curl -s -H 'X-Vault-Token: {VAULT_TOKEN}' -d '{{\"ciphertext\":\"{decrypt_input}\"}}' {VAULT_ADDR}/v1/transit/decrypt/{KEY_NAME}"

                  return f"""
                  <html>
                  <head>
                    <style>
                      body {{ font-family: Arial; }}
                      .container {{ display: flex; gap: 40px; }}
                      .box {{ flex: 1; border: 1px solid #ccc; padding: 20px; }}
                      input, textarea {{ width: 100%; margin-top: 8px; }}
                      textarea {{ height: 100px; }}
                    </style>
                  </head>
                  <body>
                    <h2>ğŸ” Vault Transit Engine Demo</h2>
                    <a href="/">â¬… DB Secret ãƒ‡ãƒ¢ã¸æˆ»ã‚‹</a>
                    <div class="container">
                      <div class="box">
                        <h3>ğŸ“ æš—å·åŒ–</h3>
                        <form method="post">
                          <input type="hidden" name="mode" value="encrypt" />
                          <label>å¹³æ–‡:</label><br>
                          <input name="encrypt_input" value="{encrypt_input}" /><br><br>
                          <button type="submit">ğŸ”’ æš—å·åŒ–</button>
                        </form>
                        {"<h4>æš—å·åŒ–çµæœ:</h4><textarea readonly>" + ciphertext + "</textarea>" if ciphertext else ""}
                        {"<h4>curl:</h4><textarea readonly>" + encrypt_curl + "</textarea>" if encrypt_curl else ""}
                      </div>
                      <div class="box">
                        <h3>ğŸ”“ å¾©å·åŒ–</h3>
                        <form method="post">
                          <input type="hidden" name="mode" value="decrypt" />
                          <label>æš—å·æ–‡:</label><br>
                          <textarea name="decrypt_input">{decrypt_input}</textarea><br>
                          <button type="submit">ğŸ”“ å¾©å·åŒ–</button>
                        </form> 
                        {"<h4>å¾©å·çµæœ:</h4><textarea readonly>" + plaintext + "</textarea>" if plaintext else ""}
                        {"<h4>curl:</h4><textarea readonly>" + decrypt_curl + "</textarea>" if decrypt_curl else ""}
                      </div>
                    </div>
                  </body>
                  </html>
                  """

              if __name__ == "__main__":
                  app.run(host="0.0.0.0", port=5000)
              EOF

              python app.py
          ports:
            - containerPort: 5000
          volumeMounts:
            - mountPath: /etc/tls
              name: tls-certs
              readOnly: true
      volumes:
        - name: tls-certs
          emptyDir: {}